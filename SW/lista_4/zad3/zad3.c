#include <avr/io.h>
#include <stdio.h>
#include <inttypes.h>
#include <util/delay.h>
#include <math.h>
#include <stdlib.h>

#define BAUD 9600                          // baudrate
#define UBRR_VALUE ((F_CPU)/16/(BAUD)-1)   // zgodnie ze wzorem

#define LED1 PB1 //D9
#define LED2 PB2
#define LED3 PB3 //D11
#define LED_PORT PORTB

// inicjalizacja UART
void uart_init()
{
  // ustaw baudrate
  UBRR0 = UBRR_VALUE;
  // włącz odbiornik i nadajnik
  UCSR0B = _BV(RXEN0) | _BV(TXEN0);
  // ustaw format 8n1
  UCSR0C = _BV(UCSZ00) | _BV(UCSZ01);
}

// transmisja jednego znaku
int uart_transmit(char data, FILE *stream)
{
  // czekaj aż transmiter gotowy
  while(!(UCSR0A & _BV(UDRE0)));
  UDR0 = data;
  return 0;
}

// odczyt jednego znaku
int uart_receive(FILE *stream)
{
  // czekaj aż znak dostępny
  while (!(UCSR0A & _BV(RXC0)));
  return UDR0;
}

FILE uart_file;

void timers_init()
{
  // TIMER 1
  ICR1 = 255;
  OCR1A = 255;
  TCCR1A = _BV(COM1A1) | _BV(WGM11); //ustaw PWM fast
  TCCR1B = _BV(WGM12) | _BV(WGM13) | _BV(CS10) ; //preskaler
  //TIMER 2
  OCR0A= 255;
  OCR0B= 255;
  TCCR0A = _BV(COM0B1) | _BV(WGM00)| _BV(WGM01); //ustaw PWM fast
  TCCR0B = _BV(WGM02) | _BV(CS02) | _BV(CS00)  ; //preskaler
  //TIMER 3
  OCR2A= 255;
  OCR2B= 255; 
  TCCR2A = _BV(COM2B1) | _BV(WGM21)| _BV(WGM20); //ustaw PWM fast
  TCCR2B = _BV(WGM22) | _BV(CS21); //preskaler
  // ustaw pin (PB1) jako wyjście
  DDRB |= _BV(LED1) | _BV(LED2) | _BV(LED3);
}

int hsl[][3]={{255, 0, 0},{255, 8, 0},{255, 17, 0},{255, 25, 0},{255, 34, 0},{255, 42, 0},{255, 51, 0},{255, 59, 0},{255, 68, 0},{255, 76, 0},{255, 85, 0},{255, 93, 0},{255, 102, 0},{255, 110, 0},{255, 119, 0},{255, 127, 0},{255, 136, 0},{255, 144, 0},{255, 153, 0},{255, 161, 0},{255, 170, 0},{255, 178, 0},{255, 187, 0},{255, 195, 0},{255, 204, 0},{255, 212, 0},{255, 221, 0},{255, 229, 0},{255, 238, 0},{255, 246, 0},{255, 255, 0},{246, 255, 0},{237, 255, 0},{229, 255, 0},{221, 255, 0},{212, 255, 0},{203, 255, 0},{195, 255, 0},{187, 255, 0},{178, 255, 0},{169, 255, 0},{161, 255, 0},{153, 255, 0},{144, 255, 0},{135, 255, 0},{127, 255, 0},{119, 255, 0},{110, 255, 0},{101, 255, 0},{93, 255, 0},{85, 255, 0},{76, 255, 0},{67, 255, 0},{59, 255, 0},{51, 255, 0},{42, 255, 0},{33, 255, 0},{25, 255, 0},{17, 255, 0},{8, 255, 0},{0, 255, 0},{0, 255, 8},{0, 255, 16},{0, 255, 25},{0, 255, 34},{0, 255, 42},{0, 255, 51},{0, 255, 59},{0, 255, 67},{0, 255, 76},{0, 255, 84},{0, 255, 93},{0, 255, 102},{0, 255, 110},{0, 255, 119},{0, 255, 127},{0, 255, 135},{0, 255, 144},{0, 255, 152},{0, 255, 161},{0, 255, 170},{0, 255, 178},{0, 255, 187},{0, 255, 195},{0, 255, 203},{0, 255, 212},{0, 255, 220},{0, 255, 229},{0, 255, 238},{0, 255, 246},{0, 255, 255},{0, 246, 255},{0, 238, 255},{0, 229, 255},{0, 220, 255},{0, 212, 255},{0, 203, 255},{0, 195, 255},{0, 187, 255},{0, 178, 255},{0, 170, 255},{0, 161, 255},{0, 152, 255},{0, 144, 255},{0, 135, 255},{0, 127, 255},{0, 119, 255},{0, 110, 255},{0, 102, 255},{0, 93, 255},{0, 84, 255},{0, 76, 255},{0, 67, 255},{0, 59, 255},{0, 51, 255},{0, 42, 255},{0, 34, 255},{0, 25, 255},{0, 16, 255},{0, 8, 255},{0, 0, 255},{8, 0, 255},{16, 0, 255},{25, 0, 255},{33, 0, 255},{42, 0, 255},{50, 0, 255},{59, 0, 255},{68, 0, 255},{76, 0, 255},{85, 0, 255},{93, 0, 255},{102, 0, 255},{110, 0, 255},{119, 0, 255},{127, 0, 255},{135, 0, 255},{144, 0, 255},{152, 0, 255},{161, 0, 255},{169, 0, 255},{178, 0, 255},{186, 0, 255},{195, 0, 255},{204, 0, 255},{212, 0, 255},{221, 0, 255},{229, 0, 255},{238, 0, 255},{246, 0, 255},{255, 0, 255},{255, 0, 246},{255, 0, 238},{255, 0, 229},{255, 0, 221},{255, 0, 212},{255, 0, 204},{255, 0, 195},{255, 0, 186},{255, 0, 178},{255, 0, 169},{255, 0, 161},{255, 0, 152},{255, 0, 144},{255, 0, 135},{255, 0, 127},{255, 0, 119},{255, 0, 110},{255, 0, 102},{255, 0, 93},{255, 0, 85},{255, 0, 76},{255, 0, 68},{255, 0, 59},{255, 0, 50},{255, 0, 42},{255, 0, 33},{255, 0, 25},{255, 0, 16},{255, 0, 8}};

int main()
{
  // zainicjalizuj UART
  uart_init();
  // skonfiguruj strumienie wejścia/wyjścia
  fdev_setup_stream(&uart_file, uart_transmit, uart_receive, _FDEV_SETUP_RW);
  stdin = stdout = stderr = &uart_file;
  // mierz napięcie
  timers_init();
  int j;

  while(1) {
      int r = rand()%179;
      int *elem=hsl[r];
      ICR1 = (255 - elem[0]);
      OCR0B = (255 - elem[1]);
      OCR2B = (225 - elem[2]);
      _delay_ms(1000);
  }
}
